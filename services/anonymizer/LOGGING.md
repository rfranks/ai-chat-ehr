# Anonymizer logging guidelines

The anonymizer service processes PHI and must avoid leaking sensitive values to
logs. All log statements MUST:

- Emit high-level metadata only (counts, booleans, identifiers generated by the
  platform) and never raw strings copied from Firestore, Presidio, or Postgres
  payloads.
- Redact or summarize collections before logging them. Use the
  `scrub_for_logging` helper to automatically replace strings, UUIDs, and other
  potentially sensitive scalars with a `<redacted>` placeholder.
- Prefer dedicated summary helpers (e.g., `summarize_patient_document`) that
  return booleans and aggregate counts rather than raw data.
- Explicitly opt-in to preserving values for known-safe keys (such as
  `recordId`, `status`, or internal status codes) by passing the `allow_keys`
  parameter to `scrub_for_logging`.

Whenever new logging is added under `services/anonymizer`, ensure:

1. The payload is passed through `scrub_for_logging` or derived from
   `summarize_patient_document` before logging.
2. Tests are updated to cover new sanitisation logic when additional allow-list
   entries or summary helpers are introduced.
3. The resulting log messages can be safely shared outside of the production
   environment without revealing PHI.
